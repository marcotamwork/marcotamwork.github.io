[{"content":"","date":"4 February 2024","permalink":"/tags/azure/","section":"Tags","summary":"","title":"Azure"},{"content":"","date":"4 February 2024","permalink":"/tags/iac/","section":"Tags","summary":"","title":"IaC"},{"content":"Introduction # Hello everyone! In this article, I will show you how to provision cloud resources for a 3-Tier architecture through IaC by Terraform and deploy the application in Kubernetes(AKS).\nTerraform as a cornerstone in IaC, revolutionizes modern IT practices, offering unparalleled benefits for reliability and agility. Notably, Terraform sets itself apart by being cloud-agnostic, allowing for the seamless integration of multiple providers and services, and creating a comprehensive representation and management of the entire infrastructure ecosystem and its associated services.\nWith my experience on cloud architecture, I will demonstrate all processes from provisioning cloud infrastructure to application deployment. In this case, assuming our customer have DevOps Team to handle operational workloads and will deploy monitoring tools to observe performance of their applications, we deploy Kubernetes service instead of container service, in order to provide more control and flexibility.\nAnd in this blog, we will first go through all steps on how we provision cloud infrastructure in Azure by Terraform with well-designed cloud strategy, from considering aspect of security, data protection, monitoring, etc. So, let\u0026rsquo;s get started!\nFor more information on Terraform, please refer to Terraform and Azure Provider for information and documents.\nArchitecture # Before you begin # To complete this document you need the following resources:\nAzure Account Azure Service Principal To create Azure Account and Service Principal, please refer to Azure Account and Azure Service Principal.\nNote: The whole demonstration will run in bash, Azzure CLI, and TF code for further CICD.\nStep 1: Set up TF project # The first thing for Terraform is to set up the location of the tf state. TF state tracks the current state of your infrastructure and resources and allows Terraform to manage and update them as needed. We choose Azure Blob Storage as backend for Terraform in our demonstration.\nNote: Azure Blob Storage provides server-side encryption to protect your data, by preventing unauthorized access and safeguarding sensitive data.\nCreate Azure Blob Storage # Before you create blob storage, sign in with Azure CLI.\nAPPID=\u0026#34;\u0026lt;app-id\u0026gt;\u0026#34; SPPASSWORD=\u0026#34;\u0026lt;password-or-cert\u0026gt;\u0026#34; SPTENANT=\u0026#34;\u0026lt;tenant\u0026gt;\u0026#34; # Login with service-principal az login --service-principal -u $APPID -p $SPPASSWORD --tenant $SPTENANT Then, run Azure CLI to create resource group, storage account and blob container for storing tf state.\n#!/bin/bash RESOURCE_GROUP_NAME=\u0026#34;project-tfstate\u0026#34; STORAGE_ACCOUNT_NAME=\u0026#34;project-tfstate-sa\u0026#34; CONTAINER_NAME=\u0026#34;project-tfstate-sa-blob\u0026#34; # Create resource group az group create --name $RESOURCE_GROUP_NAME --location eastus # Create storage account az storage account create --resource-group $RESOURCE_GROUP_NAME --name $STORAGE_ACCOUNT_NAME --sku Standard_LRS --encryption-services blob # Create blob container az storage container create --name $CONTAINER_NAME --account-name $STORAGE_ACCOUNT_NAME Create Terraform State # Terraform’s backend defines where Terraform stores its state data files. Thus, we define backend in your Terraform configuration to create Azure Blob Storage backend.\nNote: We use the name of Storage Account, resource group, and blob storage created in the pervious step as variables in those configurations.\n# provider.tf terraform { backend \u0026#34;azurerm\u0026#34; { resource_group_name = \u0026#34;project-tfstate\u0026#34; storage_account_name = \u0026#34;project-tfstate-sa\u0026#34; container_name = \u0026#34;project-tfstate-sa-blob\u0026#34; key = \u0026#34;demo.terraform.tfstate\u0026#34; } } Provider Configuration # Terraform relies on plugins called providers to interact with cloud providers, SaaS providers, and other APIs. Thus, we add provider \u0026ldquo;azurerm\u0026rdquo; for Terraform to interact with Azure.\nNote: Specify the version on provider as for provider versioning, and avoid accidental upgrades to incompatible new versions.\n# provider.tf terraform { required_providers { azurerm = { source = \u0026#34;hashicorp/azurerm\u0026#34; version = \u0026#34;=3.79.0\u0026#34; } } backend \u0026#34;azurerm\u0026#34; { .... } } # Configure the Azure provider provider \u0026#34;azurerm\u0026#34; { features { key_vault { purge_soft_delete_on_destroy = true recover_soft_deleted_key_vaults = true } } storage_use_azuread = true skip_provider_registration = true } Step 2: Creating Cloud Resource with Terraform # As for 3-Tier architecture, we will create VMs, Kubernetes cluster, Database, Storage, VNet, etc step by step. Before we start coding on resources, we define some variables first.\nVariables and Data # Specifying their values in variable definitions files(with a filename ending in either .tfvars or .tfvars.json) helps to set lots of variables in different environments. So we divide 1 .tfvar file to set the value of variable per environment and 1 .tf file to declare input variables.\nNote: We can specify file by environment on the terraform command line with flag \u0026quot;-var-file\u0026quot;. The command will be shown later.\n# test.tfvars environment = \u0026#34;test\u0026#34; location = \u0026#34;East Asia\u0026#34; # variable.tf variable \u0026#34;environment\u0026#34; { type = string } variable \u0026#34;location\u0026#34; { type = string } More, we use terraform data to get current Azure subscription and current configuration of AzureRM provider.\n# data.tf data \u0026#34;azurerm_subscription\u0026#34; \u0026#34;current\u0026#34; {} data \u0026#34;azurerm_client_config\u0026#34; \u0026#34;current\u0026#34; {} Note: Data sources serve as a bridge between the current infrastructure and the desired configuration, allowing for more dynamic and context-aware provisioning.\nResource Group # Providing a management layer that enables you to manage resources in Azure account, we create a resource group first and organize our infrastructure within the resource group.\n# Resource Group resource \u0026#34;azurerm_resource_group\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project-rg-${var.environment}\u0026#34; location = var.location tags = { Environment = \u0026#34;${var.environment}\u0026#34; } } Virtual Network # Let’s create an Azure Virtual Network and subnets.\nVNet # This deploys a virtual network called \u0026ldquo;project-vnet-test\u0026rdquo; inside resource group \u0026ldquo;project-rg-test\u0026rdquo; with an address space of \u0026ldquo;10.0.0.0/16\u0026rdquo;, which will allow you to deploy multiple subnets in that range.\n# vnet.tf # Create a virtual network resource \u0026#34;azurerm_virtual_network\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project-vnet-${var.environment}\u0026#34; address_space = [\u0026#34;10.0.0.0/16\u0026#34;] location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name tags = { Environment = \u0026#34;${var.environment}\u0026#34; } } Subnet # Building 3 subnets for AKS Node pool, Storage Account, and MySQL, we hold CIDR \u0026ldquo;10.0.2.0/24\u0026rdquo; for later defining AKS’s network profile. Subnet are then defined with address prefixes:\n\u0026ldquo;10.0.1.0/24\u0026rdquo; for AKS node pool subnet \u0026ldquo;10.0.3.0/24\u0026rdquo; for Storage subnet \u0026ldquo;10.0.4.0/24\u0026rdquo; for MySQL subnet For subnet \u0026ldquo;project-db-subnet-test\u0026rdquo;, we delegated the subnet to \u0026ldquo;Microsoft.DBforMySQL/flexibleServers\u0026rdquo; means that only Azure Database for MySQL flexible server instances can use that subnet.\nLast but not least, all subnets were added \u0026ldquo;Microsoft.Storage\u0026rdquo; for service endpoint for secure and direct connectivity to Azure Storage service.\nNote: Virtual Network (VNet) service endpoint provides secure and direct connectivity to Azure services over an optimized route over the Azure backbone network.\nNote: Subnet delegation provides full control to the customer on managing the integration of Azure services into their virtual networks.\n# vnet.tf ### CIDR \u0026#34;10.0.2.0/24\u0026#34; is delegated for AKS services # Subnet for AKS node pool resource \u0026#34;azurerm_subnet\u0026#34; \u0026#34;node_subnet\u0026#34; { name = \u0026#34;project-node-subnet-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name virtual_network_name = azurerm_virtual_network.project.name address_prefixes = [\u0026#34;10.0.1.0/24\u0026#34;] service_endpoints = [\u0026#34;Microsoft.Storage\u0026#34;] } # Subnet for Storage resource \u0026#34;azurerm_subnet\u0026#34; \u0026#34;storage_subnet\u0026#34; { name = \u0026#34;project-storage-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name virtual_network_name = azurerm_virtual_network.project.name address_prefixes = [\u0026#34;10.0.3.0/24\u0026#34;] service_endpoints = [\u0026#34;Microsoft.Storage\u0026#34;] } # Subnet for MySQL resource \u0026#34;azurerm_subnet\u0026#34; \u0026#34;db_subnet\u0026#34; { name = \u0026#34;project-db-subnet-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name virtual_network_name = azurerm_virtual_network.project.name address_prefixes = [\u0026#34;10.0.4.0/24\u0026#34;] service_endpoints = [\u0026#34;Microsoft.Storage\u0026#34;] delegation { name = \u0026#34;fs\u0026#34; service_delegation { name = \u0026#34;Microsoft.DBforMySQL/flexibleServers\u0026#34; actions = [ \u0026#34;Microsoft.Network/virtualNetworks/subnets/join/action\u0026#34;, ] } } } Network Security Group # Security rules in network security groups enable us to filter the type of network traffic that can flow in and out of virtual network subnets and network interfaces. We create 1 NSG to filter traffic that flow in and out MySQL subnet.\n# nsg.tf # Security Group resource \u0026#34;azurerm_network_security_group\u0026#34; \u0026#34;nsg\u0026#34; { name = \u0026#34;project-sg-${var.environment}\u0026#34; location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name security_rule { name = \u0026#34;AllowMySQL\u0026#34; priority = 100 direction = \u0026#34;Inbound\u0026#34; access = \u0026#34;Allow\u0026#34; protocol = \u0026#34;Tcp\u0026#34; source_port_range = \u0026#34;*\u0026#34; destination_port_range = \u0026#34;3306\u0026#34; source_address_prefix = \u0026#34;10.0.2.0/24\u0026#34; destination_address_prefix = \u0026#34;10.0.4.0/24\u0026#34; } tags { environment = \u0026#34;${var.environment}\u0026#34; } } resource \u0026#34;azurerm_subnet_network_security_group_association\u0026#34; \u0026#34;data\u0026#34; { subnet_id = azurerm_subnet.example.id network_security_group_id = azurerm_network_security_group.nsg.id } User Assigned Identity # We then create 1 UAI as prerequisites for MySQL server. The managed identity will be configured to MySQL server, and so we can authorize with UAI to MySQL database securly.\nNote: You may also create a managed identity as a standalone Azure resource. You can create a user-assigned managed identity and assign it to one or more Azure Resources.\n# uai.tf # User Assigned Identity resource \u0026#34;azurerm_user_assigned_identity\u0026#34; \u0026#34;uai\u0026#34; { name = \u0026#34;project-uai-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name location = azurerm_resource_group.project.location } Key Vault # More, we create Key Vault as secure store for secrets. And 2 2048 bit RSA keys will be created, separately for MySQL and Storage Account.\nNote: Premium level pricing tier adds Thales HSM (Hardware Security Modules) to Key Vault comparing to standard level pricing tier. please refer to Azure Key Vault pricing.\nNote: Access policys of key vault is nearly providing full access to UAI and user as for demo. Please adjust according to your need. Here is one example on requirement of access policy for Data encryption for Azure Database for MySQLMySQL fexible server.\n# key_vault.tf # Key Vault resource \u0026#34;azurerm_key_vault\u0026#34; \u0026#34;key\u0026#34; { name = \u0026#34;project-dbkey-${var.environment}\u0026#34; location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name enabled_for_disk_encryption = true tenant_id = data.azurerm_client_config.current.tenant_id soft_delete_retention_days = 90 # value can be between 7 and 90 (the default) days purge_protection_enabled = true # Once Purge Protection has been enabled it\u0026#39;s not possible to disable it sku_name = \u0026#34;standard\u0026#34; # refer to pricing tier, possible values are standard and premium } # Access Policy for yourself resource \u0026#34;azurerm_key_vault_access_policy\u0026#34; \u0026#34;yourself\u0026#34; { key_vault_id = azurerm_key_vault.key.id tenant_id = data.azurerm_client_config.current.tenant_id object_id = data.azurerm_client_config.current.object_id key_permissions = [ \u0026#34;Get\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Update\u0026#34;, \u0026#34;Create\u0026#34;, \u0026#34;Import\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;Backup\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Decrypt\u0026#34;, \u0026#34;Encrypt\u0026#34;, \u0026#34;UnwrapKey\u0026#34;, \u0026#34;WrapKey\u0026#34;, \u0026#34;Verify\u0026#34;, \u0026#34;Sign\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Release\u0026#34;, \u0026#34;Rotate\u0026#34;, \u0026#34;GetRotationPolicy\u0026#34;, \u0026#34;SetRotationPolicy\u0026#34; ] secret_permissions = [ \u0026#34;Backup\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;Get\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Set\u0026#34; ] storage_permissions = [ \u0026#34;Backup\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;DeleteSAS\u0026#34;, \u0026#34;Get\u0026#34;, \u0026#34;GetSAS\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;ListSAS\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;RegenerateKey\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Set\u0026#34;, \u0026#34;SetSAS\u0026#34;, \u0026#34;Update\u0026#34; ] } # Access Policy for UAI resource \u0026#34;azurerm_key_vault_access_policy\u0026#34; \u0026#34;uai\u0026#34; { key_vault_id = azurerm_key_vault.key.id tenant_id = azurerm_user_assigned_identity.uai.tenant_id object_id = azurerm_user_assigned_identity.uai.principal_id key_permissions = [ \u0026#34;Get\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Update\u0026#34;, \u0026#34;Create\u0026#34;, \u0026#34;Import\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;Backup\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Decrypt\u0026#34;, \u0026#34;Encrypt\u0026#34;, \u0026#34;UnwrapKey\u0026#34;, \u0026#34;WrapKey\u0026#34;, \u0026#34;Verify\u0026#34;, \u0026#34;Sign\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Release\u0026#34;, \u0026#34;Rotate\u0026#34;, \u0026#34;GetRotationPolicy\u0026#34;, \u0026#34;SetRotationPolicy\u0026#34; ] secret_permissions = [ \u0026#34;Backup\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;Get\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Set\u0026#34; ] storage_permissions = [ \u0026#34;Backup\u0026#34;, \u0026#34;Delete\u0026#34;, \u0026#34;DeleteSAS\u0026#34;, \u0026#34;Get\u0026#34;, \u0026#34;GetSAS\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;ListSAS\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;RegenerateKey\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Set\u0026#34;, \u0026#34;SetSAS\u0026#34;, \u0026#34;Update\u0026#34; ] } # We will add Access Policy for Storage Account later # Key resource \u0026#34;azurerm_key_vault_key\u0026#34; \u0026#34;db\u0026#34; { name = \u0026#34;project-dbkey-${var.environment}\u0026#34; key_vault_id = azurerm_key_vault.key.id key_type = \u0026#34;RSA\u0026#34; key_size = 2048 key_opts = [ \u0026#34;decrypt\u0026#34;, \u0026#34;encrypt\u0026#34;, \u0026#34;sign\u0026#34;, \u0026#34;unwrapKey\u0026#34;, \u0026#34;verify\u0026#34;, \u0026#34;wrapKey\u0026#34;, ] rotation_policy { automatic { time_before_expiry = \u0026#34;P30D\u0026#34; #ISO 8601 duration } expire_after = \u0026#34;P3Y\u0026#34; #ISO 8601 duration notify_before_expiry = \u0026#34;P29D\u0026#34; #ISO 8601 duration } } resource \u0026#34;azurerm_key_vault_key\u0026#34; \u0026#34;storage\u0026#34; { name = \u0026#34;project-storagekey-${var.environment}\u0026#34; key_vault_id = azurerm_key_vault.key.id key_type = \u0026#34;RSA\u0026#34; key_size = 2048 key_opts = [ \u0026#34;decrypt\u0026#34;, \u0026#34;encrypt\u0026#34;, \u0026#34;sign\u0026#34;, \u0026#34;unwrapKey\u0026#34;, \u0026#34;verify\u0026#34;, \u0026#34;wrapKey\u0026#34;, ] rotation_policy { automatic { time_before_expiry = \u0026#34;P30D\u0026#34; #ISO 8601 duration } expire_after = \u0026#34;P3Y\u0026#34; #ISO 8601 duration notify_before_expiry = \u0026#34;P29D\u0026#34; #ISO 8601 duration } } Storage # As mentioned before, storage will be created, to store content (eg. image, video) and log from MySQL server.\nStorage Account # Storage Account is created as Geo-redundant storage for this demo. It takes advantage as Azure will replicates your storage account synchronously across Azure availability zones in the same region.\nNote: Flag \u0026ldquo;account_replication_type\u0026rdquo; refers to Azure Storage redundancy. Valid options are LRS, GRS, RAGRS, ZRS, GZRS and RAGZRS. Please adjust the value according to your needs. For example, vaule \u0026ldquo;GRS\u0026rdquo; may be needed for production environment.\n# storage.tf # Storage Account resource \u0026#34;azurerm_storage_account\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project${var.environment}storage\u0026#34; resource_group_name = azurerm_resource_group.project.name location = azurerm_resource_group.project.location account_tier = \u0026#34;Standard\u0026#34; # refer to pricing tier, possible values are standard and premium account_replication_type = \u0026#34;ZRS\u0026#34; # Value changing may forces a new resource to be created large_file_share_enabled = \u0026#34;false\u0026#34; public_network_access_enabled = \u0026#34;true\u0026#34; # public network access is enabled as for testing environment # Example to setup blob properties # blob_properties { # change_feed_enabled = \u0026#34;true\u0026#34; # last_access_time_enabled = \u0026#34;true\u0026#34; # versioning_enabled = \u0026#34;true\u0026#34; # delete_retention_policy { # days = 35 # } # restore_policy { # days = 30 # } # } identity { type = \u0026#34;SystemAssigned\u0026#34; # type of Managed Service Identity configured on Storage Account } lifecycle { ignore_changes = [ customer_managed_key # customer managed key will be manage in other teeraform resource ] } } Network Rules for Storage Account # Note: Only one azurerm_storage_account_network_rules can be tied to an azurerm_storage_account.\n# storage.tf # Network Rules for Storage Account resource \u0026#34;azurerm_storage_account_network_rules\u0026#34; \u0026#34;myipandsubnet\u0026#34; { storage_account_id = azurerm_storage_account.project.id default_action = \u0026#34;Deny\u0026#34; ip_rules = [\u0026#34;xxx.x.xxx.xxx\u0026#34;] # edit value to your home IP or whitelisted ip virtual_network_subnet_ids = [azurerm_subnet.storage_subnet.id, azurerm_subnet.db_subnet.id, azurerm_subnet.node_subnet.id] # subnet ids to secure the storage account bypass = [\u0026#34;Metrics\u0026#34;] } Data Encrytion for Storage Account # Notes that resource \u0026ldquo;azurerm_storage_account\u0026rdquo; are ignoring changes in block \u0026ldquo;customer_managed_key\u0026rdquo; as we manage Customer Managed Key by resource \u0026ldquo;azurerm_storage_account_customer_managed_key\u0026rdquo;.\nNote: It\u0026rsquo;s possible to define a Customer Managed Key both within resource \u0026ldquo;azurerm_storage_account\u0026rdquo; via block \u0026ldquo;customer_managed_key\u0026rdquo; and by using the resource \u0026ldquo;azurerm_storage_account_customer_managed_key\u0026rdquo;. However it\u0026rsquo;s not possible to use both methods to manage a Customer Managed Key for a Storage Account, since there\u0026rsquo;ll be conflicts.\n# key.tf resource \u0026#34;azurerm_key_vault_access_policy\u0026#34; \u0026#34;storage\u0026#34; { key_vault_id = azurerm_key_vault.key.id tenant_id = data.azurerm_client_config.current.tenant_id object_id = azurerm_storage_account.project.identity.0.principal_id # Principal ID for the Service Principal associated with Identity of Storage Account secret_permissions = [\u0026#34;Get\u0026#34;] key_permissions = [\u0026#34;Get\u0026#34;, \u0026#34;Create\u0026#34;, \u0026#34;List\u0026#34;, \u0026#34;Restore\u0026#34;, \u0026#34;Recover\u0026#34;, \u0026#34;UnwrapKey\u0026#34;, \u0026#34;WrapKey\u0026#34;, \u0026#34;Purge\u0026#34;, \u0026#34;Encrypt\u0026#34;, \u0026#34;Decrypt\u0026#34;, \u0026#34;Sign\u0026#34;, \u0026#34;Verify\u0026#34;] } # storage.tf # Data Encrytion for Storage Account resource \u0026#34;azurerm_storage_account_customer_managed_key\u0026#34; \u0026#34;storage_key\u0026#34; { storage_account_id = azurerm_storage_account.project.id key_vault_id = azurerm_key_vault.key.id key_name = azurerm_key_vault_key.storage.name } Storage Blob Container # After all setting created, we create Blob Container to storage files.\n# Storage Blob Container resource \u0026#34;azurerm_storage_container\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project-blob\u0026#34; storage_account_name = azurerm_storage_account.project.name container_access_type = \u0026#34;blob\u0026#34; } MySQL # For MySQL, we choose to provision MySQL Flexible Server (Azure Database for MySQL - Single Server is scheduled for retirement by September 16, 2024).\nNote: To learn difference between MySQL Single Server and MySQL Flexible Server, please refer to here.\nPrivate DNS Zone # We create Private DNS Zone for MySQL server to make sure database connect in a secure way within our VNet.\n# private_dns.tf resource \u0026#34;azurerm_private_dns_zone\u0026#34; \u0026#34;database\u0026#34; { name = \u0026#34;project.${var.environment}.mysql.database.azure.com\u0026#34; resource_group_name = azurerm_resource_group.project.name } resource \u0026#34;azurerm_private_dns_zone_virtual_network_link\u0026#34; \u0026#34;db_links\u0026#34; { name = \u0026#34;${azurerm_virtual_network.project.name}-${var.environment}.com\u0026#34; private_dns_zone_name = azurerm_private_dns_zone.database.name resource_group_name = azurerm_resource_group.project.name virtual_network_id = azurerm_virtual_network.project.id } MySQL Database Server # Note that compute size \u0026ldquo;D2ads v5\u0026rdquo; is newly added in Region East Asia, pricing calculator isn\u0026rsquo;t updated on the choice of MySQL compute size when I used this size. Cost is $0.1420 USD on 6 Feb 2024. For more information, please refer to compute size and cost.\nBy experience, I advise to set mode of block \u0026ldquo;high_availability\u0026rdquo; to \u0026ldquo;ZoneRedundant\u0026rdquo;. It can only be set before we create it. You CANNOT change HA mode to Zone-redundant if you created server with same-zone mode once.\nNote: Flag \u0026ldquo;private_dns_zone_id\u0026rdquo; is required when setting flag \u0026ldquo;delegated_subnet_id\u0026rdquo;. Private DNS zone should end with suffix \u0026lsquo;.mysql.database.azure\u0026rsquo;.com.\n# mysql.tf # MySQL Database Server resource \u0026#34;azurerm_mysql_flexible_server\u0026#34; \u0026#34;main\u0026#34; { name = \u0026#34;project-mysqlserver-${var.environment}\u0026#34; location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name delegated_subnet_id = azurerm_subnet.db_subnet.id # Changing value forces a new MySQL Flexible Server to be created private_dns_zone_id = azurerm_private_dns_zone.database.id zone = \u0026#34;1\u0026#34; administrator_login = \u0026#34;projectadmin\u0026#34; administrator_password = \u0026#34;xxxxxx\u0026#34; # change to your own password sku_name = \u0026#34;GP_Standard_D2ads_v5\u0026#34; # refer to SKU tier and compute size storage { size_gb = 20 auto_grow_enabled = true # must be \u0026#34;true\u0026#34; to enable `high_availability` } identity { type = \u0026#34;UserAssigned\u0026#34; identity_ids = [azurerm_user_assigned_identity.uai.id] # use created UAI as Service Identity } # Data Encrytion customer_managed_key { key_vault_key_id = azurerm_key_vault_key.db.id # set Encrytion key with created key primary_user_assigned_identity_id = azurerm_user_assigned_identity.uai.id } version = \u0026#34;5.7\u0026#34; # MySQL version, change to your own required version backup_retention_days = 30 # default 7 days high_availability { mode = \u0026#34;ZoneRedundant\u0026#34; # prefer set it to ZoneRedundant, mode can be change when you created server standby_availability_zone = 2 } tags = { Environment = \u0026#34;${var.environment}\u0026#34; } depends_on = [azurerm_private_dns_zone_virtual_network_link.db_links] lifecycle { ignore_changes = [ zone, high_availability.0.standby_availability_zone # avoid to migrate MySQL Flexible Server back to primary Availability Zone if a fail-over occured ] # prevent_destroy = true # prevent destroy for production environment } } Active Directory administrator # Here is example to provide admin access to myself. The solution can be used to provide server admin access to corresponding team with UAI.\nresource \u0026#34;azurerm_mysql_flexible_server_active_directory_administrator\u0026#34; \u0026#34;me\u0026#34; { server_id = azurerm_mysql_flexible_server.main.id identity_id = azurerm_user_assigned_identity.prod.id login = \u0026#34;sqladmin\u0026#34; object_id = data.azurerm_client_config.current.client_id # myself tenant_id = data.azurerm_client_config.current.tenant_id # myself } Server Audit Log # We enable audit log by updating server configurations. Audit log will be exported to Storage by updating Diagnostic Setting. Retention policy of audit log will be handled later.\nNote: Please refer to audit-logs and tutorial to learn more on audit log setting, including audit log events.\nNote: Feature \u0026ldquo;retention_policy\u0026rdquo; has been deprecated in favor of resource \u0026ldquo;azurerm_storage_management_policy\u0026rdquo;.\n# MySQL Database Server Parameters resource \u0026#34;azurerm_mysql_flexible_server_configuration\u0026#34; \u0026#34;audit_log_enabled\u0026#34; { name = \u0026#34;audit_log_enabled\u0026#34; resource_group_name = azurerm_resource_group.project.name server_name = azurerm_mysql_flexible_server.main.name value = \u0026#34;ON\u0026#34; # enable audit log } resource \u0026#34;azurerm_mysql_flexible_server_configuration\u0026#34; \u0026#34;audit_log_events\u0026#34; { name = \u0026#34;audit_log_events\u0026#34; resource_group_name = azurerm_resource_group.project.name server_name = azurerm_mysql_flexible_server.main.name value = \u0026#34;CONNECTION,GENERAL\u0026#34; # controls the events to be logged } # Example on setting MySQL users to be included for logging. # resource \u0026#34;azurerm_mysql_flexible_server_configuration\u0026#34; \u0026#34;audit_log_include_users\u0026#34; { # name = \u0026#34;audit_log_include_users\u0026#34; # resource_group_name = azurerm_resource_group.project.name # server_name = azurerm_mysql_flexible_server.main.name # value = \u0026#34;projectadmin\u0026#34; # } # MySQL Database Diagnostic Setting resource \u0026#34;azurerm_monitor_diagnostic_setting\u0026#34; \u0026#34;mysqlauditlog\u0026#34; { name = \u0026#34;mysqlauditlog\u0026#34; target_resource_id = azurerm_mysql_flexible_server.main.id storage_account_id = azurerm_storage_account.project.id # storage account that logs will be sent enabled_log { category = \u0026#34;MySqlAuditLogs\u0026#34; # possible values are \u0026#34;MySqlSlowLogs\u0026#34; and \u0026#34;MySqlAuditLogs\u0026#34; for MySQL flexible server retention_policy { enabled = false } } metric { category = \u0026#34;AllMetrics\u0026#34; enabled = false retention_policy { enabled = false } } depends_on = [ azurerm_mysql_flexible_server_configuration.audit_log_enabled, azurerm_mysql_flexible_server_configuration.audit_log_events ] } # Storage Lifecycle for MySQL Audit Log resource \u0026#34;azurerm_storage_management_policy\u0026#34; \u0026#34;project_mysql\u0026#34; { storage_account_id = azurerm_storage_account.project.id rule { name = \u0026#34;mysql-auditlog-lifecycle\u0026#34; enabled = true filters { prefix_match = [\u0026#34;am-containerlog/WorkspaceResourceId=/subscriptions\u0026#34;] blob_types = [\u0026#34;blockBlob\u0026#34;] } actions { base_blob { tier_to_cool_after_days_since_modification_greater_than = 30 tier_to_archive_after_days_since_modification_greater_than = 90 delete_after_days_since_modification_greater_than = 2555 } version { change_tier_to_archive_after_days_since_creation = 15 change_tier_to_cool_after_days_since_creation = 7 delete_after_days_since_creation = 30 } } } } MySQL Database # After all audit log settings created, we create MySQL Database.\n# MySQL Database resource \u0026#34;azurerm_mysql_flexible_database\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project-mysqldb-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name server_name = azurerm_mysql_flexible_server.main.name charset = \u0026#34;utf8mb4\u0026#34; collation = \u0026#34;utf8mb4_unicode_ci\u0026#34; } Azure Kubernetes Cluster (AKS) # Log Analytics Workspace # In order to store and read cluster log, we create Log Analytics Workspace to query log.\nlog.tf # Log Analytics for AKS resource \u0026#34;azurerm_log_analytics_workspace\u0026#34; \u0026#34;aks_insights\u0026#34; { name = \u0026#34;project-aks-${var.environment}-log\u0026#34; location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name sku = \u0026#34;Free\u0026#34; # use tier \u0026#34;Free\u0026#34; as for test environment, defaults to \u0026#34;PerGB2018\u0026#34; retention_in_days = 7 # workspace\u0026#39;s default retention, 7 days (Free Tier only), range between 30 and 730 days for other tier # daily_quota_gb = 0.5 # default value of 0.5 for free tier } Kubernetes Cluster # As a hosted Kubernetes service, Azure handles critical tasks, like health monitoring and maintenance. AKS will automatically create a node resource group, contains all of the infrastructure resources associated with the cluster, name as \u0026quot;MC_${resource_group}_${AKS_name}_${region}\u0026quot;.\nKubenet was chosen as networking option(CNI) in my experience, as we didn\u0026rsquo;t have enough information to design networking at the initial stage when we were working for project. I advise to choose Azure CNI for better solution, also better performance and adding transparency to network.\nNote: Please refer to AKS: Kubenet vs Azure CNI to learn more on difference between Kubenet and Azure CNI.\nNote: AKS has a high Log Analytics cost, including Container Insights, Prometheus and Grafana. Determine if feature should be enable or not by consdering project budget. Learn more to enable these monitoring features.\n# aks.tf # AKS resource \u0026#34;azurerm_kubernetes_cluster\u0026#34; \u0026#34;main\u0026#34; { name = \u0026#34;project-aks-${var.environment}\u0026#34; location = azurerm_resource_group.project.location resource_group_name = azurerm_resource_group.project.name dns_prefix = \u0026#34;project-k8s-${var.environment}\u0026#34; # For production change to \u0026#34;Standard\u0026#34; sku_tier = \u0026#34;Free\u0026#34; # Can also be set to Standard # latest recommended version will be used if kubernetes_version isn\u0026#39;t specified # kubernetes_version = 1.29 network_profile { network_plugin = \u0026#34;azure\u0026#34; # choosing Azure CNI as networking option(CNI) network_policy = \u0026#34;azure\u0026#34; # currently use Azure Network Policy Manager, possible values are calico, azure and cilium dns_service_ip = \u0026#34;10.0.2.10\u0026#34; service_cidr = \u0026#34;10.0.2.0/24\u0026#34; } default_node_pool { name = \u0026#34;default\u0026#34; vm_size = \u0026#34;Standard_D2_v5\u0026#34; # 2 CPU, 8 GiB, On Demand $0.1320USD for Region East Asia vnet_subnet_id = azurerm_subnet.node_subnet.id # use created node subnet type = \u0026#34;VirtualMachineScaleSets\u0026#34; # use \u0026#34;VirtualMachineScaleSets\u0026#34; in order to enable auto-scaling enable_auto_scaling = true node_count = 1 min_count = 1 max_count = 2 # Kubernetes labels for nodes node_labels = { env = \u0026#34;test\u0026#34; } } identity { type = \u0026#34;UserAssigned\u0026#34; identity_ids = [azurerm_user_assigned_identity.uai.id] # use created UAI as Service Identity } # Enable Container insights for real time pod logging oms_agent { log_analytics_workspace_id = azurerm_log_analytics_workspace.aks_insights.id } tags = { Environment = \u0026#34;${var.environment}\u0026#34; } } ＃ create output to config AKS in Terraform\u0026#39;s provider if needed # output \u0026#34;client_certificate\u0026#34; { # value = azurerm_kubernetes_cluster.main.kube_config.0.client_certificate # # sensitive = true # } # # output \u0026#34;kube_config\u0026#34; { # value = azurerm_kubernetes_cluster.main.kube_config_raw # # sensitive = true # } Azure Container Registry # We then create Azure Container Registry in order to build, store, and manage container images.\n# Container Registry resource \u0026#34;azurerm_container_registry\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;projectRegistry${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name location = azurerm_resource_group.project.location sku = \u0026#34;Basic\u0026#34; # use basic tier as we dont need large storage to store image } # Attaching ACR to AKS # Role Assignment for AKS resource \u0026#34;azurerm_role_assignment\u0026#34; \u0026#34;project_role\u0026#34; { principal_id = azurerm_kubernetes_cluster.main.kubelet_identity[0].object_id role_definition_name = \u0026#34;AcrPull\u0026#34; scope = azurerm_container_registry.project.id skip_service_principal_aad_check = true } Budget # Creating budget to monitor all of Azure service charges and track your actual Azure service costs.\nAction Group # Action group can perform various actions when your budget threshold is met. We can also enable mobile push notifications by enabling Azure app push notifications while configuring the action group. But here we use email as demo.\n# budget.tf # Action Group for Contact resource \u0026#34;azurerm_monitor_action_group\u0026#34; \u0026#34;project_subscription\u0026#34; { name = \u0026#34;project_subscription_monitoring_${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name short_name = \u0026#34;project\u0026#34; email_receiver { name = \u0026#34;sendtoadmin\u0026#34; email_address = \u0026#34;marcotam.work@gmail.com\u0026#34; use_common_alert_schema = true } email_receiver { name = \u0026#34;sendtodevops\u0026#34; email_address = \u0026#34;mymanager@gmail.com\u0026#34; use_common_alert_schema = true } } Budget # For budget, we use 2 resource groups as budget scope, with budget amount $1000 USD. And different contact option were shown in code below.\n# budget.tf # Budget resource \u0026#34;azurerm_consumption_budget_subscription\u0026#34; \u0026#34;project_subscription\u0026#34; { name = \u0026#34;project_subscription_budget-${var.environment}\u0026#34; subscription_id = data.azurerm_subscription.current.id amount = 1000 # setting USD$1000 for total time_grain = \u0026#34;Monthly\u0026#34; time_period { start_date = formatdate(\u0026#34;YYYY-MM-01\u0026#39;T\u0026#39;00:00:00Z\u0026#34;, timestamp()) # take current date as start date } filter { dimension { name = \u0026#34;ResourceGroupName\u0026#34; values = [ azurerm_resource_group.project.name, \u0026#34;MC_project-${var.environment}_project-aks-${var.environment}_eastasia\u0026#34; # initial resource group and AKS resource group ] } } notification { enabled = true threshold = 70.0 operator = \u0026#34;EqualTo\u0026#34; # contact option on action groups contact_groups = [ azurerm_monitor_action_group.project_subscription.id, ] } notification { enabled = true threshold = 100.0 operator = \u0026#34;EqualTo\u0026#34; # contact option on roles contact_roles = [ \u0026#34;Owner\u0026#34;, ] } notification { enabled = true threshold = 100.0 operator = \u0026#34;GreaterThan\u0026#34; threshold_type = \u0026#34;Forecasted\u0026#34; # contact option on email contact_emails = [ \u0026#34;mymanager@gmail.com\u0026#34;, \u0026#34;marcotam.work@gmail.com\u0026#34; ] } depends_on = [ azurerm_kubernetes_cluster.main ] lifecycle { ignore_changes = [ time_period ] } } Backup # The main targets on backup is all the data stored in project. Azure Database for MySQL flexible server automatically creates server backups. Thus, we need to create backup for storage. We will use Azure Backup to back up our blob storage.\nBackup Vault # We create Backup vault to houses backup data for certain newer Backup workloads.\nNote: We choose Vaulted backup as it retain data for a maximum of 10 years. Please refer to backup for Azure Blobs using Azure Backup to learn more on difference between operational and vaulted backups.\n# backup.tf # Backup Vault resource \u0026#34;azurerm_data_protection_backup_vault\u0026#34; \u0026#34;project\u0026#34; { name = \u0026#34;project-backup-${var.environment}\u0026#34; resource_group_name = azurerm_resource_group.project.name location = azurerm_resource_group.project.location datastore_type = \u0026#34;VaultStore\u0026#34; # possible values are ArchiveStore, OperationalStore, SnapshotStore and v. choose OperationalStore or VaultStore for Storage Backup redundancy = \u0026#34;LocallyRedundant\u0026#34; # possible values are GeoRedundant, LocallyRedundant and ZoneRedundant. Cost will change according to value. Changing this forces a new Backup Vault to be created. identity { type = \u0026#34;SystemAssigned\u0026#34; } } Role Assignment for Storage BackUp # Assign required access for backup vault inorder to protect storage account from any accidental deletions by applying Backup-owned Delete Lock.\n# backup.tf # Role Assignment for Storage BackUp resource \u0026#34;azurerm_role_assignment\u0026#34; \u0026#34;storage_backup\u0026#34; { scope = azurerm_storage_account.project.id role_definition_name = \u0026#34;Storage Account Backup Contributor\u0026#34; principal_id = azurerm_data_protection_backup_vault.project.identity[0].principal_id } Backup Policy and Backup Instance # Backup policy defines the schedule and frequency of the recovery points creation, and its retention duration in the Backup vault. Thus, we create backup for Storage Account.\n# backup.tf # Backup policy for Storage Account resource \u0026#34;azurerm_data_protection_backup_policy_blob_storage\u0026#34; \u0026#34;storage_policy\u0026#34; { name = \u0026#34;project-backup-${var.environment}\u0026#34; vault_id = azurerm_data_protection_backup_vault.project.id retention_duration = \u0026#34;P30D\u0026#34; # #ISO 8601 duration } # Backup for Storage Account resource \u0026#34;azurerm_data_protection_backup_instance_blob_storage\u0026#34; \u0026#34;example\u0026#34; { name = \u0026#34;project-backup-storage-${var.environment}\u0026#34; vault_id = azurerm_data_protection_backup_vault.project.id location = azurerm_resource_group.project.location storage_account_id = azurerm_storage_account.project.id backup_policy_id = azurerm_data_protection_backup_policy_blob_storage.storage_policy.id depends_on = [azurerm_role_assignment.storage_backup] # required role Assignment for Storage BackUp } Conclusion # The whole architecture was assumed as test environment and self-owned, so most of the tier was chosen as Free tier or the cheapest one. Beside database, monitoring and backup service are also expensive service to use here in the solution, and also some service didn\u0026rsquo;t use in this blog like firewall. As a cloud engineer, we should always follow solid cloud strategy and best practices. Depends on your purpose, you can decide if those cloud services should be used, especially for self-hosting environment.\nAnd that\u0026rsquo;s all for this blog, thank you!\n","date":"4 February 2024","permalink":"/posts/tf_azure-3tier/","section":"Posts","summary":"IaC on 3-Tier architecture through Terraform in Azure","title":"IaC on 3-Tier architecture through Terraform in Azure"},{"content":"","date":"4 February 2024","permalink":"/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"4 February 2024","permalink":"/tags/terraform/","section":"Tags","summary":"","title":"Terraform"},{"content":" HelloWorld! Welcome to Marco\u0026rsquo;s blog! With this blog,I will share my experience on several cloud engineering solutions or DevOps solution, including IaC on Azure, AWS, and GCP, python function Lambda and workflow on GCP, build cicd pipeline etc. Enjoy!\n","date":"4 February 2024","permalink":"/","section":"Welcome to my blog! 🎉","summary":"HelloWorld!","title":"Welcome to my blog! 🎉"},{"content":"Hi! My name\u0026rsquo;s Marco and I\u0026rsquo;m a Cloud DevOps Engineer from Hong Kong. Previously I worked at Green Tomato, working with different local and global clients in the financial sector, to support and process the cloud transformation, and build cloud architecture in different projects.\nHere is my blog, to show several cloud engineering solutions or DevOps solution, including IaC on Azure, AWS, and GCP, python function Lambda and workflow on GCP, build cicd pipeline etc.\n","date":"14 August 2023","permalink":"/posts/1stpost/","section":"Posts","summary":"This is my first post on my site","title":"Introduction"},{"content":"","date":"14 August 2023","permalink":"/tags/space/","section":"Tags","summary":"","title":"space"},{"content":" ","date":"13 June 2022","permalink":"/posts/","section":"Posts","summary":" ","title":"Posts"},{"content":"","date":"1 January 0001","permalink":"/authors/","section":"Authors","summary":"","title":"Authors"},{"content":"","date":"1 January 0001","permalink":"/categories/","section":"Categories","summary":"","title":"Categories"},{"content":"","date":"1 January 0001","permalink":"/series/","section":"Series","summary":"","title":"Series"},{"content":"","date":"1 January 0001","permalink":"/topics/","section":"Topics","summary":"","title":"Topics"}]